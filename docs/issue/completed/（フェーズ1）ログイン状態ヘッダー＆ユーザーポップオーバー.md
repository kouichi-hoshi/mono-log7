---
title: （フェーズ1）ログイン状態ヘッダー＆ユーザーポップオーバー（スタブ連携）
labels: ["phase-1", "layout", "auth", "ui", "test"]
related_checklist: ["P1-LAY-03", "P1-LAY-04", "P1-AUTH-04", "P1-AUTH-05"]
---

## 背景 / 目的

- `docs/04. 作業計画書.md` と `docs/05. 作業計画進行チェックリスト.md` では、フェーズ1で画面B（ログイン中タイムライン）のヘッダー＆ユーザー導線を整備することが求められている。
- 現状は画面A（未ログイン）まではスタブで動作しているが、ログイン状態のヘッダー枠（`P1-LAY-03`）やユーザーポップオーバー（`P1-AUTH-04/05`）は未着手で、セッション分岐（`P1-LAY-04`）もミドルウェアに反映されていない。
- 本Issueでは **スタブセッション前提** でログイン中ヘッダーとユーザーポップオーバーを完成させ、画面B以降のUI/CRUD実装（表示切替、エディタ、一覧）に進める準備を整える。

## 現状（確認事項）

- `authAdapter` と `postRepository` のスタブは完成済み（`P1-ADP-02/03`）。
- 画面Aのヘッダー/フッター/ウェルカムUIは実装済み（`P1-LAY-02`, `P1-LAY-05`, `P1-WELC-01〜03`）。
- `ThemeProvider` 基盤（Issue #5 / `P1-ENV-05`）は進行中のため、ヘッダー内のUIは今後のTheme対応を意識しつつスタブ実装を進める。
- ログイン状態のレイアウト（md以上での表示切替枠＋ユーザーアイコン）とポップオーバー、ログアウト導線は未実装。

## ゴール

- ログイン状態で画面Bに遷移した際、ヘッダーレイアウトが仕様どおり（md以上は中央に表示切替枠＋右側ユーザーアイコン、md未満は右上にアイコンのみ）で表示される。
- ユーザーアイコン押下でポップオーバーが開閉し、ユーザー名とログアウト導線が表示される。
- ログアウト押下で `authAdapter.logout()`（スタブ）が呼び出され、セッションが未ログイン状態に戻り画面Aへリダイレクト/描画切替される。
- ミドルウェア（またはServer Componentロジック）でスタブセッションを判定し、未ログイン/ログインのビュー分岐が成立する。
- すべての挙動が Jest + RTL で Red→Green→Refactor を経て担保される。

## スコープ

### このIssueでやること

1. **セッション判定の導入（`P1-LAY-04`）**
   - `middleware.ts` または `app/layout.tsx` 配下で `authAdapter.getSession()` のスタブ結果を参照し、未ログインは画面A、ログイン中は画面Bのレイアウトブロックを描画。
   - NODE_ENV=production ではスタブを無効化している既存ガードを尊重しつつ、開発/テストではスタブセッションで挙動を確認できるようにする。
2. **ログインヘッダー枠（`P1-LAY-03`）**
   - md以上: 中央エリアに表示切替UIのプレースホルダ、右端にユーザーアイコン（Popoverトリガ）を配置。
   - md未満: ユーザーアイコンのみ（右上固定）。表示切替UIは後続（`P1-LAY-07`）で画面下部へ配置予定のため、ここではヘッダーには載せない。
3. **ユーザーポップオーバー（`P1-AUTH-04`）**
   - shadcnの Popover コンポーネントを利用し、アイコンクリックで開閉。
   - コンテンツ: ユーザー名、ログアウトリンク、（後続の日記トグル等のプレースホルダ枠を確保しても良い）。
   - 外側クリックや Esc キーで閉じるテストを追加。
4. **ログアウト導線（`P1-AUTH-05`）**
   - Popover 内のボタン/リンク押下で `authAdapter.logout()` → `revalidatePath` or `redirect` equivalent を行い、未ログイン状態へ戻す。
   - ログアウト後はスタブセッションがクリアされる前提でテストを記述。
5. **テスト & TDD**
   - レイアウト描画、Popover開閉、ログアウトイベント、セッション分岐を Jest + RTL + `@testing-library/user-event` で Red→Green。

### このIssueではやらないこと

- 表示切替UIの実装（`P1-LAY-07`, `P1-FLT-01` など）。本Issueでは配置枠の確保のみ。
- 日記モードトグルや設定の永続化（`P1-DIA-01/02`）。
- CRDU投稿機能（エディタ、一覧、ゴミ箱など）。
- 本番Auth.js接続（フェーズ2タスク）。

## 受け入れ条件（Done）

- ログイン状態を想定したページでヘッダーレイアウトが仕様どおりに表示される（mdブレークポイント対応含む）。
- Popoverの開閉、外側クリックでのクローズ、Escキーでのクローズが正常に動作する。
- ログアウト操作でスタブセッションが初期化され、未ログイン画面（画面A）へ戻る。
- ミドルウェア／サーバー側でのセッション判定により、リロードしても適切な画面が選択される。
- Jest + RTL の関連テストがGREEN（レイアウト、Popover、ログアウト、セッション分岐をカバー）。

## 実装メモ（案）

- `authAdapter` 呼び出しは `lib/authAdapter.ts` の既存APIを利用し、環境変数でスタブ/本物を切り替える現状仕様に準拠する。
- セッション分岐は `app/page.tsx` で Server Component の `getSession()` をawaitして分岐する方法でも良いが、`middleware.ts` でのリダイレクトや `layout.tsx` での条件分岐など、設計書（`docs/03`）に記載の方針を確認のうえ選択する。
- ユーザーアイコン表示にはダミーアバター（円背景＋イニシャル）を採用予定。実データ取得は後続（Auth.js接続）で差し替え可能なように抽象化する。
- Popoverコンテンツのボタンは `@/components/ui/button` を再利用し、shadcn推奨のアクセシビリティ属性（`aria-expanded` 等）を踏襲する。
- レスポンシブ挙動は Tailwind のユーティリティで制御し、`md` ブレークポイント境界でDOM構造を切り替える際はテストでも `window.matchMedia` のモックを用いて分岐を検証する。

## テスト方針（案）

1. **レイアウト描画テスト**
   - スタブセッション（ログイン状態）をモックし、`AppHeader` が md 以上／未満で期待する要素を描画するか確認。
2. **Popover動作テスト**
   - `user-event` でアイコンをクリック → Popover表示、外側クリックorEscで閉じる挙動を検証。
3. **ログアウト動作テスト**
   - Popover内ボタン押下で `authAdapter.logout` が1回だけ呼ばれ、コールバックが未ログインUIを描画することを検証。
4. **セッション分岐テスト**
   - `getSession` を未ログイン／ログインでモックし、描画される画面が切り替わることを確認。

## 依存 / 後続

- 依存: `P1-ADP-02`（authAdapterスタブ）、`P1-UI-07`（Popoverコンポーネント）、ThemeProvider基盤（Issue #5）※UIのスタイル整合性のため。
- 後続: 表示切替UI（`P1-LAY-07`, `P1-FLT-01/02`）、日記モードトグル（`P1-DIA-01/02`）、エディタ/一覧/ゴミ箱各タスク。これらは本Issueで整備したヘッダーおよびセッション分岐を前提に実装する。

## 参照ドキュメント

- `docs/02. 要件定義書.md`
  - 「画面B（ログイン中タイムライン）のレイアウト・表示切替・ユーザー操作」
- `docs/03. 設計書.md`
  - 「画面分岐方針」「ヘッダー構造」「認証スタブ運用」「Popover仕様」
- `docs/04. 作業計画書.md`
  - `1-B/1-C` セクション（ヘッダー、ユーザーアイコン、ログアウト導線）
- `docs/05. 作業計画進行チェックリスト.md`
  - `P1-LAY-03`, `P1-LAY-04`, `P1-AUTH-04`, `P1-AUTH-05`


