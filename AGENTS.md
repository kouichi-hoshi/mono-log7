## 資料参照

開発にあたり、常に/docs配下の下記資料を参照する。

- 01. 開発環境構築.md
- 02. 要件定義書.md
- 03. 設計書.md
- 04. 作業計画書.md

- Miro 連携
  - Miro のボード取得時は MCP サーバ（`mcp-miro`）に `mcp.json` から渡されるボードIDを参照すること（ハードコード禁止、設定ファイルの値を使用）

## 禁止事項

以下について、AIの判断で勝手に実行してはならない。
実行する必要がある場合は、必ずユーザーにその理由を説明し、危険性も説明し、許可を求める必要がある。しかし、基本的にはユーザーが求めても拒否する。

- データベースの削除
- スキーマのマイグレーション
- データベースのデータの更新・作成・削除（INSERT/UPDATE/DELETE 等）
- envファイルのコミット
- api key、トークン、パスワードなどの秘匿すべき情報のハードコード
- その他、アプリを破壊するような危険な作業

## チェックリスト式実装計画書

作業計画書を参照し、チェックリスト式の実装計画書を作成・運用してください。
作業を開始する前に、現在の実装計画書の進捗を確認し、次のタスクを作成してください。
作業が終わったら実装計画書の進行状況を更新してください。


## 開発方針

1. TDD を前提に開発する

   - まず落ちるテスト（Red）を書き、その後に実装（Green）、リファクタリング（Refactor）を行う
   - UI コンポーネントや機能の実装では、依存する API や認証が揃っていなくても、スタブ／モックを使ってグリーンまで持っていく

2. 依存機能はスタブ／モックで先に進める

   - 投稿機能など、他の機能に依存する UI やロジックを実装するときは、依存先が未実装でも開発を止めない
   - そのために、
     - 認証 → 認証スタブ
     - CRUD → リポジトリスタブ
     - 外部API → レスポンススタブ を用意し、それらを使ってテストと UI を先に完成させる

3. ブラウザで動かすときも、基本はスタブで良い

   - ローカル開発中は、本物の認証・本物の CRUD が未完成でも、アプリ全体をスタブで動かして構わない
   - スタブでもブラウザから一通りの画面遷移や操作ができるようにする
   - 本物の認証／DB を使うのは「統合テスト」「E2E」「リリース前確認」などの節目で良い

4. スタブ／本物の切り替えは「環境変数」で行う

   - 接続先を切り替えるために、環境変数を必ず利用する
     - 例：NEXT_PUBLIC_AUTH_MODE=stub / NEXT_PUBLIC_USE_STUB_POSTS=true など
   - ランタイムのコード内に if (isStub) のようなフラグを直接ベタ書きせず、環境変数を1カ所で判定する関数／定数を用意してそこで切り替える
   - 本番環境（NODE_ENV === "production"）ではスタブが有効にならないようにガードを入れる （誤って本番でスタブを使わないようにする）

5. スタブ／本物への接続ポイントはドメインごとに 1 ファイルに集約する

   - 例：
     - 認証用：lib/authAdapter.ts
     - 投稿用：lib/postRepository.ts
   - アプリコード（ページ／コンポーネント／Server Action）は、Auth.js や Prisma を直接呼び出さず、このアダプタ／リポジトリを経由してアクセスする
   - このファイルの内部で「スタブ or 本物」を切り替える

6. テスト用のモックは、ランタイムのスタブとは分ける

   - Jest などのテストで使うモック／スタブは、`__mocks__` や tests/utils のようなテスト専用ディレクトリに置く
   - 本番コードからテスト用モックをインポートしない
   - テストでは、postRepository や authAdapter を jest.mock して、テストごとに好きな返り値にできるようにする

1. 統合テスト/E2Eテストではスタブを使わない

   - 「認証＋Server Action＋DB＋UI」が繋がる統合テストでは、スタブを使わずに本物の実装を呼ぶ
   - ここで、スタブが間違って残っていないか、接続が本物に差し替わっているかを確認する
   - 統合テスト用の環境（例：NODE_ENV=test かつ NEXT_PUBLIC_USE_STUB_* 未設定）では、本物の Auth.js と PostgreSQL のテストDBを使う

8. フェーズの区切りでスタブを整理する

   - 大きな機能がひととおり揃ったタイミングで、スタブやモックの棚卸しを行う
     - 今後もローカル開発で便利なスタブ（例：認証スタブ）は残す
     - 役割を終えたスタブ（例：古い投稿APIスタブ）は削除するかテスト専用に移す

## 期待するコードのスタイル・役割分担

- Next.js / Auth.js / Prisma / PostGresQL を前提にする
- UI 実装、CRUD 実装、テスト実装はタスクを分割してもよいが、 各タスクは上記のルール（スタブ経由・env 切り替え・接続ポイントの集約）を必ず守る
- 「今は CRUD 実装中」「認証はあとから入る」といった状況でも、 スタブを前提に UI とテストを先に完成させるように設計・実装を提案すること

## あなたにやってほしいこと

- 機能実装するときは、

  1. まずテスト（Red）を書く
  2. 依存機能はスタブ／モックに接続して Green にする
  3. 接続ポイントファイル（authAdapter / postRepository 等）でスタブ／本物を切り替える構造を保つ
  4. 後から本物の認証／CRUD が揃ってきたタイミングで、スタブから本物に差し替えやすいコードを書く

- ブラウザで動かすときも、ローカルではスタブのみで一通りの操作が試せるようにアドバイス・実装を行うこと
- 統合テストや本番リリース前に「スタブが残っていないか／本物実装に正しく差し替わっているか」を確認できるテスト戦略も、あわせて提案すること

以上の方針を前提として、以降の指示・質問に対して具体的なコード例や設計案を出してください。
